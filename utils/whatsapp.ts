import { Sale, db } from '../db.ts';
import pako from 'pako';

export const formatNaira = (amount: number) => {
  return new Intl.NumberFormat('en-NG', {
    style: 'currency',
    currency: 'NGN',
    minimumFractionDigits: 0
  }).format(amount);
};

export const shareReceiptToWhatsApp = (sale: Sale) => {
  const shopName = localStorage.getItem('shop_name') || 'NaijaShop';
  const shopInfo = localStorage.getItem('shop_info') || '';
  const date = new Date(sale.timestamp).toLocaleString('en-NG', {
    dateStyle: 'medium',
    timeStyle: 'short'
  });
  
  const transId = sale.id ? String(sale.id).padStart(5, '0') : 'N/A';

  let message = `ðŸ›ï¸ *${shopName.toUpperCase()}*\n`;
  if (shopInfo) message += `ðŸ“ ${shopInfo}\n`;
  message += `--------------------------\n`;
  message += `ðŸ“œ *RECEIPT #${transId}*\n`;
  message += `ðŸ“… Date: ${date}\n`;
  message += `--------------------------\n`;
  message += `ðŸ“¦ *ITEMS:*\n`;
  
  sale.items.forEach(item => {
    const itemTotal = item.price * item.quantity;
    message += `â€¢ ${item.name} x ${item.quantity} ... ${formatNaira(itemTotal)}\n`;
  });
  
  message += `--------------------------\n`;
  message += `ðŸ’° *TOTAL: ${formatNaira(sale.total)}*\n`;
  message += `--------------------------\n`;
  message += `ðŸ™ *Thank you for your business!*\n`;
  message += `\n_Generated by NaijaShop POS_ ðŸ‡³ðŸ‡¬`;

  const encodedMessage = encodeURIComponent(message);
  window.open(`https://api.whatsapp.com/send?text=${encodedMessage}`, '_blank');
};

/**
 * Generates a full shop setup key (Inventory + Staff Users)
 */
export const generateShopKey = async () => {
  const inventory = await db.inventory.toArray();
  const users = await db.users.toArray();
  const shopName = localStorage.getItem('shop_name') || 'NaijaShop';
  const shopInfo = localStorage.getItem('shop_info') || '';

  const payload = {
    inventory,
    users,
    settings: { shopName, shopInfo }
  };

  const jsonStr = JSON.stringify(payload);
  const base64 = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g, (match, p1) => 
    String.fromCharCode(parseInt(p1, 16))
  ));
  
  const key = `SHOP-KEY-${base64}`;
  const message = `ðŸš€ *Shop Setup Key for ${shopName}*\n\nCopy the text below and paste it into your Shop Manager app to sync inventory and staff.\n\n${key}`;

  try {
    await navigator.clipboard.writeText(key);
    alert('Setup Key copied to clipboard! You can now paste it into WhatsApp.');
  } catch (err) {
    console.error('Clipboard failed', err);
  }

  if (navigator.share && key.length < 1500) {
    try {
      await navigator.share({ title: 'Staff Setup Key', text: message });
    } catch (e) {
      window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`, '_blank');
    }
  } else {
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(message.substring(0, 1500))}`, '_blank');
  }
};

/**
 * Generates a key for syncing MASTER stock back to staff after reconciliation.
 */
export const generateMasterStockKey = async () => {
  const inventory = await db.inventory.toArray();
  const shopName = localStorage.getItem('shop_name') || 'NaijaShop';

  const payload = {
    inventory,
    type: 'STOCK_UPDATE',
    timestamp: Date.now()
  };

  const jsonStr = JSON.stringify(payload);
  const base64 = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g, (match, p1) => 
    String.fromCharCode(parseInt(p1, 16))
  ));
  
  const key = `STOCK-SYNC-${base64}`;
  const message = `ðŸ“¦ *Master Stock Update: ${shopName}*\n\nStaff: Use this key to reset your stock counts to match the Boss's records.\n\n${key}`;

  if (navigator.share && key.length < 1500) {
    try {
      await navigator.share({ title: 'Stock Update Key', text: message });
    } catch (e) {
      window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`, '_blank');
    }
  } else {
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(message.substring(0, 1500))}`, '_blank');
  }
};

export const decodeShopKey = (key: string) => {
  const trimmedKey = key.trim();
  const isSetup = trimmedKey.includes('SHOP-KEY-');
  const isStock = trimmedKey.includes('STOCK-SYNC-');
  
  if (!isSetup && !isStock) return null;
  
  try {
    const match = trimmedKey.match(/(?:SHOP-KEY-|STOCK-SYNC-)([A-Za-z0-9+/=]+)/);
    if (!match) return null;
    
    const base64 = match[1];
    const jsonStr = decodeURIComponent(Array.prototype.map.call(atob(base64), (c: any) => 
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
    
    return JSON.parse(jsonStr);
  } catch (e) {
    console.error('Decode error:', e);
    return null;
  }
};

export type BackupResult = {
  success: boolean;
  method: 'FILE_SHARE' | 'TEXT_SHARE' | 'DOWNLOAD';
  fileName?: string;
  totalRecords?: number;
};

export const backupToWhatsApp = async (data: any): Promise<BackupResult> => {
  const shopName = data.shopName || 'NaijaShop';
  const timestamp = data.timestamp || Date.now();
  const dateStr = new Date(timestamp).toISOString().split('T')[0];
  const fileName = `NAIJASHOP_SAFE_BACKUP_${dateStr}.json.gz`;
  
  const totalRecords = Object.values(data).reduce((acc: number, val: any) => {
    return acc + (Array.isArray(val) ? val.length : 0);
  }, 0) as number;

  const jsonString = JSON.stringify(data);
  const uint8Data = new TextEncoder().encode(jsonString);
  const compressed = pako.gzip(uint8Data);
  
  const shareTitle = `Shop Backup: ${shopName}`;
  const shareText = `This is my Compressed Secure Shop Backup for ${dateStr}. Keep this file safe. It contains all history.`;

  if (navigator.share) {
    try {
      const blob = new Blob([compressed], { type: 'application/gzip' });
      const file = new File([blob], fileName, { type: 'application/gzip' });

      await navigator.share({ title: shareTitle, text: shareText, files: [file] });
      await db.settings.put({ key: 'last_backup_timestamp', value: Date.now() });
      return { success: true, method: 'FILE_SHARE', fileName, totalRecords };
    } catch (stage1Error) {
      try {
        await navigator.share({ title: shareTitle, text: `NaijaShop Backup Data: ${jsonString}` });
        await db.settings.put({ key: 'last_backup_timestamp', value: Date.now() });
        return { success: true, method: 'TEXT_SHARE', totalRecords };
      } catch (stage2Error) {
        console.error("Stage 2 failed.", stage2Error);
      }
    }
  }

  try {
    const blob = new Blob([compressed], { type: 'application/gzip' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    await db.settings.put({ key: 'last_backup_timestamp', value: Date.now() });
    return { success: true, method: 'DOWNLOAD', fileName, totalRecords };
  } catch (stage3Error) {
    return { success: false, method: 'DOWNLOAD' };
  }
};

/**
 * Reconciliation Logic: Merges Staff Sales into Admin DB.
 * 1. Checks for Duplicate Sales via UUID.
 * 2. Subtracts Staff sales quantities from Admin inventory.
 * 3. Records sales in Admin history.
 */
export const reconcileStaffSales = async (staffData: any) => {
  const staffSales = staffData.sales || [];
  if (staffSales.length === 0) return { success: true, merged: 0, skipped: 0 };

  let mergedCount = 0;
  let skippedCount = 0;

  await db.transaction('rw', [db.inventory, db.sales], async () => {
    for (const sale of staffSales) {
      // 1. Anti-Duplicate Check
      const existing = await db.sales.where('uuid').equals(sale.uuid).first();
      if (existing) {
        skippedCount++;
        continue;
      }

      // 2. Deduction Logic (The Delta)
      for (const item of sale.items) {
        // Find by ID first, then fallback to name (most robust for sync)
        let invItem = await db.inventory.get(item.id);
        if (!invItem) {
          invItem = await db.inventory.where('name').equals(item.name).first();
        }

        if (invItem) {
          const newStock = Math.max(0, (invItem.stock || 0) - item.quantity);
          await db.inventory.update(invItem.id!, { stock: newStock });
        }
      }

      // 3. Add to Admin Sales Table
      const { id, ...saleWithoutOldId } = sale; // Ensure we don't clash on local auto-increment
      await db.sales.add(saleWithoutOldId);
      mergedCount++;
    }
  });

  return { success: true, merged: mergedCount, skipped: skippedCount };
};
