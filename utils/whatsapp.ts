
import { Sale, db } from '../db.ts';

export const formatNaira = (amount: number) => {
  return new Intl.NumberFormat('en-NG', {
    style: 'currency',
    currency: 'NGN',
    minimumFractionDigits: 0
  }).format(amount);
};

export const shareReceiptToWhatsApp = (sale: Sale) => {
  const shopName = localStorage.getItem('shop_name') || 'NaijaShop';
  const shopInfo = localStorage.getItem('shop_info') || '';
  const date = new Date(sale.timestamp).toLocaleString('en-NG', {
    dateStyle: 'medium',
    timeStyle: 'short'
  });
  
  const transId = sale.id ? String(sale.id).padStart(5, '0') : 'N/A';

  let message = `ðŸ›ï¸ *${shopName.toUpperCase()}*\n`;
  if (shopInfo) message += `ðŸ“ ${shopInfo}\n`;
  message += `--------------------------\n`;
  message += `ðŸ“œ *RECEIPT #${transId}*\n`;
  message += `ðŸ“… Date: ${date}\n`;
  message += `--------------------------\n`;
  message += `ðŸ“¦ *ITEMS:*\n`;
  
  sale.items.forEach(item => {
    const itemTotal = item.price * item.quantity;
    message += `â€¢ ${item.name} x ${item.quantity} ... ${formatNaira(itemTotal)}\n`;
  });
  
  message += `--------------------------\n`;
  message += `ðŸ’° *TOTAL: ${formatNaira(sale.total)}*\n`;
  message += `--------------------------\n`;
  message += `ðŸ™ *Thank you for your business!*\n`;
  message += `\n_Generated by NaijaShop POS_ ðŸ‡³ðŸ‡¬`;

  const encodedMessage = encodeURIComponent(message);
  window.open(`https://api.whatsapp.com/send?text=${encodedMessage}`, '_blank');
};

export const generateShopKey = async () => {
  const inventory = await db.inventory.toArray();
  const users = await db.users.toArray();
  const shopName = localStorage.getItem('shop_name') || 'NaijaShop';
  const shopInfo = localStorage.getItem('shop_info') || '';

  const payload = {
    inventory,
    users,
    settings: {
      shopName,
      shopInfo
    }
  };

  const jsonStr = JSON.stringify(payload);
  const base64 = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g, (match, p1) => 
    String.fromCharCode(parseInt(p1, 16))
  ));
  
  const key = `SHOP-KEY-${base64}`;
  const message = `ðŸš€ *Shop Setup Key for ${shopName}*\n\nCopy the text below and paste it into your Shop Manager app to sync inventory and staff.\n\n${key}`;

  try {
    await navigator.clipboard.writeText(key);
    alert('Setup Key copied to clipboard! You can now paste it into WhatsApp.');
  } catch (err) {
    console.error('Clipboard failed', err);
  }

  if (navigator.share && key.length < 1500) {
    try {
      await navigator.share({
        title: 'Staff Setup Key',
        text: message
      });
    } catch (e) {
      window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`, '_blank');
    }
  } else {
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(message.substring(0, 1500))}`, '_blank');
  }
};

export const decodeShopKey = (key: string) => {
  const trimmedKey = key.trim();
  if (!trimmedKey.includes('SHOP-KEY-')) return null;
  
  try {
    const match = trimmedKey.match(/SHOP-KEY-([A-Za-z0-9+/=]+)/);
    if (!match) return null;
    
    const base64 = match[1];
    const jsonStr = decodeURIComponent(Array.prototype.map.call(atob(base64), (c) => 
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
    
    return JSON.parse(jsonStr);
  } catch (e) {
    console.error('Decode error:', e);
    return null;
  }
};

/**
 * Enhanced Backup Function
 * Tries Native Share (best for WhatsApp), fallbacks to Direct Download (best for PC/Browsers)
 */
export const backupToWhatsApp = async (data: any) => {
  const jsonString = JSON.stringify(data, null, 2);
  const dateStr = new Date().toISOString().split('T')[0];
  const fileName = `naijashop_backup_${dateStr}.json`;
  const blob = new Blob([jsonString], { type: 'application/json' });
  const file = new File([blob], fileName, { type: 'application/json' });

  // 1. Try Mobile Share API (Direct to WhatsApp)
  if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({
        title: 'NaijaShop Database Backup',
        text: `Backup data for ${localStorage.getItem('shop_name') || 'Business'}`,
        files: [file]
      });
      return; // Success!
    } catch (err) {
      console.warn('Share was cancelled or failed, trying download fallback...', err);
    }
  }

  // 2. Fail-safe Fallback: Direct File Download
  // This works everywhere, including Desktop browsers
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert("WhatsApp direct sharing is limited on this browser. \n\nYour backup file has been DOWNLOADED to your device instead. Please send this file to your WhatsApp manually to keep it safe.");
};
